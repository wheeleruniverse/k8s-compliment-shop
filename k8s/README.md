# K8s Compliment Shop - Kubernetes Deployment

This directory contains all Kubernetes deployment configurations for the k8s-compliment-shop application, managed using **Helm**, **Kustomize**, and **ArgoCD**.

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────┐
│                        Git Repository                        │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  k8s/helm/                                             │ │
│  │  ├── Chart.yaml                                        │ │
│  │  ├── values.yaml          ◄── Source of Truth         │ │
│  │  ├── templates/                                        │ │
│  │  └── kustomize/           ◄── Post-renderer patches   │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                          │
                          │ (1) Git Push
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                   GitHub Actions (CI)                        │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  1. Helm template (render templates)                  │ │
│  │  2. Kustomize build (apply patches)                   │ │
│  │  3. Save to k8s/rendered/ (vendoring)                 │ │
│  │  4. Commit back to Git for PR review                  │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                          │
                          │ (2) Rendered manifests in PR
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                      ArgoCD (CD)                             │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  1. Watches Git repository                            │ │
│  │  2. Helm template + Kustomize post-render             │ │
│  │  3. Apply to Kubernetes cluster                       │ │
│  │  4. Continuous sync & self-heal                       │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                  Kubernetes Cluster                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ web-service  │  │ bff-service  │  │prod-service  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐                                           │
│  │    MySQL     │                                           │
│  └──────────────┘                                           │
└─────────────────────────────────────────────────────────────┘
```

## Directory Structure

```
k8s/
├── helm/                           # Helm chart (source of truth)
│   ├── Chart.yaml                  # Chart metadata
│   ├── values.yaml                 # Configurable values
│   ├── templates/                  # Kubernetes resource templates
│   │   ├── _helpers.tpl           # Template helper functions
│   │   ├── web-service/           # Web service resources
│   │   ├── bff-service/           # BFF service resources
│   │   ├── product-service/       # Product service resources
│   │   └── mysql/                 # MySQL database resources
│   └── kustomize/                 # Kustomize post-renderer
│       ├── kustomization.yaml     # Kustomize config
│       ├── post-renderer.sh       # Post-renderer script
│       └── patches/               # Patch files (optional)
├── argocd/                        # ArgoCD configuration
│   ├── application.yaml           # ArgoCD Application manifest
│   └── README.md                  # ArgoCD setup guide
└── rendered/                      # Vendored manifests (generated by CI)
    └── all-resources.yaml         # Final rendered manifests
```

## Tools Overview

### 1. Helm - Templating & Package Management

**What it does:**
- Templates Kubernetes manifests with variables
- Manages application versioning
- Provides reusable charts

**Why we use it:**
- Standard way to package K8s applications
- Easy to manage configuration via `values.yaml`
- Version control for the entire application

**Key files:**
- `helm/Chart.yaml` - Chart metadata and version
- `helm/values.yaml` - All configurable values
- `helm/templates/` - Resource templates

### 2. Kustomize - Patching & Customization

**What it does:**
- Applies patches to Helm-rendered manifests
- Adds common labels, annotations
- Makes targeted modifications without changing Helm templates

**Why we use it:**
- Helm handles base templating
- Kustomize handles environment-specific patches
- Separation of concerns (template vs. patch)

**Key files:**
- `helm/kustomize/kustomization.yaml` - Main config
- `helm/kustomize/patches/` - Optional patch files
- `helm/kustomize/post-renderer.sh` - Integration script

### 3. ArgoCD - GitOps Continuous Deployment

**What it does:**
- Watches Git repository for changes
- Automatically syncs cluster state with Git
- Self-heals when cluster state drifts

**Why we use it:**
- GitOps workflow (Git as source of truth)
- Automated deployments
- Audit trail of all changes
- Easy rollbacks via Git

**Key files:**
- `argocd/application.yaml` - Defines what to deploy

### 4. GitHub Actions - CI Pipeline (Vendoring)

**What it does:**
- Renders manifests on every PR/push
- Commits rendered manifests back to Git
- Allows reviewing exact changes before deployment

**Why we use it:**
- See EXACTLY what will be deployed
- Review manifest changes in PRs
- Catch errors before ArgoCD applies them

**Key files:**
- `.github/workflows/vendor-manifests.yaml` - CI workflow
- `scripts/vendor-manifests.sh` - Vendoring script

## Quick Start

### Prerequisites

```bash
# Install Helm
brew install helm  # macOS
# or
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# Install Kustomize
brew install kustomize  # macOS
# or
curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash

# Install kubectl
brew install kubectl  # macOS

# Install ArgoCD CLI (optional)
brew install argocd  # macOS
```

### Local Development

#### 1. Render manifests locally

```bash
# Render with Helm only
helm template k8s-compliment-shop k8s/helm --namespace default

# Render with Helm + Kustomize (recommended)
helm template k8s-compliment-shop k8s/helm \
  --namespace default \
  --post-renderer k8s/helm/kustomize/post-renderer.sh

# Or use the vendoring script
./scripts/vendor-manifests.sh
```

#### 2. Validate manifests

```bash
# Lint Helm chart
helm lint k8s/helm

# Dry-run apply to cluster
helm template k8s-compliment-shop k8s/helm | kubectl apply --dry-run=client -f -
```

#### 3. Install to local cluster

```bash
# Using Helm directly
helm install k8s-compliment-shop k8s/helm \
  --namespace default \
  --post-renderer k8s/helm/kustomize/post-renderer.sh

# Or using kubectl
kubectl apply -f k8s/rendered/all-resources.yaml
```

### Production Deployment with ArgoCD

#### 1. Install ArgoCD

```bash
kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
```

#### 2. Update repository URL

Edit `k8s/argocd/application.yaml`:
```yaml
source:
  repoURL: https://github.com/YOUR-ORG/k8s-compliment-shop.git  # Update this!
```

#### 3. Deploy ArgoCD Application

```bash
kubectl apply -f k8s/argocd/application.yaml
```

#### 4. Access ArgoCD UI

```bash
# Get admin password
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d

# Port forward
kubectl port-forward svc/argocd-server -n argocd 8080:443

# Open https://localhost:8080
```

## Making Changes

### Workflow for Configuration Changes

1. **Edit `k8s/helm/values.yaml`**
   ```yaml
   webService:
     replicaCount: 3  # Change from 2 to 3
     image:
       tag: v7        # Update image version
   ```

2. **Commit and push**
   ```bash
   git add k8s/helm/values.yaml
   git commit -m "feat: scale web-service to 3 replicas"
   git push
   ```

3. **GitHub Actions runs**
   - Renders manifests with Helm + Kustomize
   - Commits rendered manifests to `k8s/rendered/`
   - Adds PR comment with changes

4. **Review rendered manifests**
   - Check `k8s/rendered/all-resources.yaml` in the PR
   - Ensure changes match expectations

5. **Merge PR**
   - ArgoCD detects Git change
   - Automatically syncs cluster
   - Application updated!

### Workflow for Template Changes

1. **Edit templates** in `k8s/helm/templates/`
2. **Test locally** with `./scripts/vendor-manifests.sh`
3. **Commit, push, review** (same as above)

### Workflow for Kustomize Patches

1. **Create patch** in `k8s/helm/kustomize/patches/`
2. **Enable in kustomization.yaml**
   ```yaml
   patchesStrategicMerge:
     - patches/my-patch.yaml
   ```
3. **Test, commit, review** (same as above)

## Common Tasks

### Update Image Version

```yaml
# k8s/helm/values.yaml
webService:
  image:
    tag: v7  # Update this
```

### Scale Replicas

```yaml
# k8s/helm/values.yaml
webService:
  replicaCount: 5  # Scale to 5 replicas
```

### Update Environment Variables

```yaml
# k8s/helm/values.yaml
webService:
  config:
    gaMeasurementId: "G-NEWID123"  # Update GA ID
```

### Add Common Labels (via Kustomize)

```yaml
# k8s/helm/kustomize/kustomization.yaml
commonLabels:
  app.kubernetes.io/part-of: k8s-compliment-shop
  team: platform
  cost-center: engineering
```

## Troubleshooting

### Helm template errors

```bash
# Lint the chart
helm lint k8s/helm

# Debug template rendering
helm template k8s-compliment-shop k8s/helm --debug
```

### Kustomize errors

```bash
# Test kustomize directly
helm template k8s-compliment-shop k8s/helm | kustomize build k8s/helm/kustomize
```

### ArgoCD sync issues

```bash
# Check application status
kubectl get application -n argocd k8s-compliment-shop

# View sync status
argocd app get k8s-compliment-shop

# Force sync
argocd app sync k8s-compliment-shop --prune
```

### View rendered manifests

```bash
# Locally
./scripts/vendor-manifests.sh
cat k8s/rendered/all-resources.yaml

# From ArgoCD
argocd app manifests k8s-compliment-shop
```

## Best Practices

1. **Always review rendered manifests** in PRs before merging
2. **Use values.yaml** for configuration (not hard-coded in templates)
3. **Use Kustomize** for environment-specific patches
4. **Version your chart** in `Chart.yaml` when making breaking changes
5. **Test locally** before pushing to Git
6. **Use ArgoCD** for deployments (not kubectl apply)
7. **Commit rendered manifests** for PR review (vendoring)

## Migration from Old Structure

The old K8s manifests in `services/*/k8s/` and `infrastructure/mysql/` have been migrated to this centralized Helm chart. You can safely delete those directories after verifying the Helm chart works correctly.

```bash
# After testing, remove old manifests
rm -rf services/*/k8s/
rm -rf infrastructure/mysql/
```

## Resources

- [Helm Documentation](https://helm.sh/docs/)
- [Kustomize Documentation](https://kustomize.io/)
- [ArgoCD Documentation](https://argo-cd.readthedocs.io/)
- [Helm + Kustomize Post-Renderer](https://helm.sh/docs/topics/advanced/#post-rendering)

## Support

For questions or issues:
1. Check this README
2. Review `k8s/argocd/README.md` for ArgoCD-specific help
3. Review `k8s/helm/kustomize/README.md` for Kustomize help
4. Check rendered manifests in `k8s/rendered/`
