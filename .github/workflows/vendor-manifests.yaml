name: Vendor Kubernetes Manifests

on:
  pull_request:
    paths:
      - 'k8s/helm/**'
      - 'scripts/vendor-manifests.sh'
  push:
    branches:
      - main
    paths:
      - 'k8s/helm/**'
      - 'scripts/vendor-manifests.sh'
  workflow_dispatch:

jobs:
  vendor-manifests:
    name: Render and Commit Manifests
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Use a PAT or default GITHUB_TOKEN
          token: ${{ secrets.GITHUB_TOKEN }}
          # Fetch full history for proper git operations
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.5.0'

      - name: Install yq (optional, for splitting manifests)
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Vendor manifests
        run: |
          chmod +x scripts/vendor-manifests.sh
          ./scripts/vendor-manifests.sh

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code k8s/rendered/ || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push if changed
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add k8s/rendered/
          git commit -m "chore: vendor manifests from Helm+Kustomize

          ðŸ¤– Auto-generated by GitHub Actions

          This commit contains the rendered Kubernetes manifests that will be applied by ArgoCD.
          Review these changes to understand what will be deployed to the cluster."
          git push

      - name: Add PR comment (on pull requests)
        if: github.event_name == 'pull_request' && steps.git-check.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## âœ… Kubernetes Manifests Vendored\n\nThe rendered manifests have been updated. Review the changes in `k8s/rendered/` to see what will be deployed by ArgoCD.\n\n**Next Steps:**\n1. Review the rendered manifests\n2. Ensure they match your expectations\n3. Merge when ready - ArgoCD will apply these manifests'
            })

      - name: No changes detected
        if: steps.git-check.outputs.changed != 'true'
        run: |
          echo "âœ… No changes in rendered manifests - everything is up to date!"
